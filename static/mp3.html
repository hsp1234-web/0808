<!DOCTYPE html>
<html lang="zh-Hant" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é³³å‡°éŸ³è¨Šè½‰éŒ„å„€ v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark body {
            background-color: #131316;
            color: #E8EAED;
        }
        body {
            background-color: #F8F9FA;
            color: #202124;
        }
        .phoenix-glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        .dark .phoenix-glass {
            background: rgba(32, 33, 36, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .phoenix-gradient-text {
            background: linear-gradient(90deg, #89CFF0, #A688FA, #F482A4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        [v-cloak] { display: none; }
        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
        }
        .status-green { background-color: #28a745; box-shadow: 0 0 8px #28a745; }
        .status-yellow { background-color: #ffc107; box-shadow: 0 0 8px #ffc107; }
        .status-red { background-color: #dc3545; box-shadow: 0 0 8px #dc3545; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div id="app" class="max-w-7xl mx-auto space-y-6" :style="{ fontSize: baseFontSize + '%' }" v-cloak>
        <!-- æ¨™é¡Œèˆ‡æ§åˆ¶é … -->
        <header class="flex justify-between items-center">
            <h1 class="text-2xl font-bold">é³³å‡° <span class="phoenix-gradient-text">éŸ³è¨Šè½‰éŒ„å„€ v3</span></h1>
            <div class="flex items-center gap-2">
                 <!-- å­—é«”å¤§å°æ§åˆ¶ -->
                <div class="flex items-center gap-1 phoenix-glass rounded-lg p-1 text-sm">
                    <span class="font-semibold px-2">å­—é«”</span>
                    <button @click="changeFontSize(-25)" class="p-1.5 hover:bg-gray-500/10 rounded-md transition-colors" :disabled="baseFontSize <= 50"><i data-lucide="zoom-out" class="w-4 h-4"></i></button>
                    <span class="font-bold w-12 text-center">{{ baseFontSize }}%</span>
                    <button @click="changeFontSize(25)" class="p-1.5 hover:bg-gray-500/10 rounded-md transition-colors" :disabled="baseFontSize >= 150"><i data-lucide="zoom-in" class="w-4 h-4"></i></button>
                </div>
                <button class="p-2 hover:bg-gray-500/10 rounded-full transition-colors">
                    <i data-lucide="sun" class="w-6 h-6"></i>
                </button>
            </div>
        </header>

        <!-- å…¨åŸŸå„€è¡¨æ¿ -->
        <div class="phoenix-glass rounded-xl p-4 sm:p-6 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="flex items-center gap-2 font-semibold">
                    <span class="status-light" :class="globalStatus.light"></span>
                    <span>ç‹€æ…‹: {{ globalStatus.text }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="cpu" class="w-5 h-5"></i>
                    <span>æ¨¡å‹: <span class="font-semibold">{{ selectedModel }}</span></span>
                </div>
                <div class="flex items-center gap-2">
                    <i data-lucide="gpu-chip" class="w-5 h-5"></i>
                    <span>GPU: <span class="font-semibold">{{ systemStats.gpu_name || 'æœªåµæ¸¬åˆ°' }}</span></span>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-3">
                <!-- é€²åº¦æ¢ -->
                <div>
                    <div class="flex justify-between items-baseline mb-1"><span class="text-sm font-medium">CPU</span><span class="text-xs font-bold">{{ systemStats.cpu_usage.toFixed(1) }}%</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700"><div class="bg-green-500 h-2 rounded-full" :style="{ width: systemStats.cpu_usage + '%' }"></div></div>
                </div>
                <div>
                    <div class="flex justify-between items-baseline mb-1"><span class="text-sm font-medium">RAM</span><span class="text-xs font-bold">{{ systemStats.ram_usage.toFixed(1) }}%</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700"><div class="bg-yellow-500 h-2 rounded-full" :style="{ width: systemStats.ram_usage + '%' }"></div></div>
                </div>
                <div v-if="systemStats.gpu_usage !== null">
                    <div class="flex justify-between items-baseline mb-1"><span class="text-sm font-medium">GPU</span><span class="text-xs font-bold">{{ systemStats.gpu_usage.toFixed(1) }}%</span></div>
                    <div class="w-full bg-gray-200 rounded-full h-2 dark:bg-gray-700"><div class="bg-purple-500 h-2 rounded-full" :style="{ width: systemStats.gpu_usage + '%' }"></div></div>
                </div>
            </div>
        </div>

        <!-- æ­¥é©Ÿä¸€ & äºŒ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- å·¦å´ï¼šé¸é … -->
            <div class="phoenix-glass rounded-xl p-4 sm:p-6 space-y-4 flex flex-col">
                <h2 class="text-xl font-semibold">âš™ï¸ æ­¥é©Ÿ 1: é¸é …</h2>
                <div class="flex-grow space-y-4">
                    <div>
                        <label for="model-select" class="block text-sm font-medium mb-1">æ¨¡å‹å¤§å°</label>
                        <select id="model-select" v-model="selectedModel" class="w-full p-2 rounded-md bg-white/60 dark:bg-black/30 border border-gray-400/50 dark:border-gray-600/50 focus:ring-2 focus:ring-sky-500">
                            <option value="tiny">Tiny (æœ€å¿«)</option>
                            <option value="base">Base</option>
                            <option value="small">Small</option>
                            <option value="medium">Medium (å»ºè­°)</option>
                            <option value="large">Large (æœ€æº–ç¢º)</option>
                        </select>
                    </div>
                    <div>
                        <label for="language-select" class="block text-sm font-medium mb-1">è½‰éŒ„èªè¨€</label>
                        <select id="language-select" v-model="selectedLanguage" class="w-full p-2 rounded-md bg-white/60 dark:bg-black/30 border border-gray-400/50 dark:border-gray-600/50 focus:ring-2 focus:ring-sky-500">
                            <option value="zh">ç¹é«”ä¸­æ–‡</option>
                            <option value="en">è‹±æ–‡</option>
                        </select>
                    </div>
                </div>
                <button class="w-full mt-4 bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-all transform hover:scale-105">âœ“ ç¢ºèªè¨­å®š</button>
            </div>
            <!-- å³å´ï¼šä¸Šå‚³ -->
            <div class="phoenix-glass rounded-xl p-4 sm:p-6 flex flex-col">
                <h2 class="text-xl font-semibold mb-4">ğŸ“¤ æ­¥é©Ÿ 2: ä¸Šå‚³æª”æ¡ˆ</h2>
                <label for="file-input" class="flex-grow rounded-xl p-6 flex flex-col items-center justify-center text-center cursor-pointer hover:border-sky-400 transition-all border-2 border-dashed border-gray-400/50">
                    <i data-lucide="upload-cloud" class="w-12 h-12 phoenix-gradient-text"></i>
                    <p class="mt-2 text-lg font-semibold">é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆåˆ°æ­¤è™•</p>
                    <input id="file-input" type="file" multiple class="hidden" @change="handleFileUpload">
                </label>
            </div>
        </div>

        <!-- æ­¥é©Ÿä¸‰: é–‹å§‹è™•ç† -->
        <div class="flex justify-center">
            <button @click="startProcessing" :disabled="uploadedFiles.length === 0" class="w-full md:w-1/2 text-lg font-bold py-3 px-6 rounded-xl bg-blue-600 text-white shadow-lg hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:shadow-none transition-all transform hover:scale-105">
                âœ¨ é–‹å§‹è™•ç† {{ uploadedFiles.length }} å€‹æª”æ¡ˆ
            </button>
        </div>

        <!-- ä»»å‹™å„€è¡¨æ¿ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- é€²è¡Œä¸­ä»»å‹™ -->
            <div class="phoenix-glass rounded-xl p-4 sm:p-6">
                <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="loader-2" class="w-6 h-6 animate-spin"></i>é€²è¡Œä¸­ä»»å‹™</h2>
                <div id="ongoing-tasks" class="space-y-3 max-h-96 overflow-y-auto">
                    <div v-if="ongoingTasks.length === 0" class="text-center text-gray-500 dark:text-gray-400 py-4">æš«ç„¡åŸ·è¡Œä¸­ä»»å‹™</div>
                    <div v-for="task in ongoingTasks" :key="task.task_id" class="p-3 rounded-lg bg-white/60 dark:bg-black/30">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold truncate w-4/5">{{ getTaskFilename(task) }}</span>
                            <span class="text-sm font-medium text-yellow-600 dark:text-yellow-400">{{ task.status }}...</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700 mt-2">
                            <div class="bg-blue-600 h-2.5 rounded-full" :style="{width: task.progress + '%'}"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å·²å®Œæˆä»»å‹™ -->
            <div class="phoenix-glass rounded-xl p-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold flex items-center gap-2"><i data-lucide="check-circle-2" class="w-6 h-6 text-green-500"></i>å·²å®Œæˆä»»å‹™</h2>
                    <button @click="downloadSelected" :disabled="selectedTasks.size === 0" class="text-sm font-semibold flex items-center gap-2 px-3 py-1.5 rounded-md bg-blue-600 text-white disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        <span>ä¸‹è¼‰å·²é¸ ({{ selectedTasks.size }})</span>
                    </button>
                </div>
                <div id="completed-tasks" class="space-y-3 max-h-96 overflow-y-auto">
                     <div v-if="completedTasks.length === 0" class="text-center text-gray-500 dark:text-gray-400 py-4">å°šç„¡å®Œæˆçš„ä»»å‹™</div>
                     <div v-for="task in completedTasks" :key="task.task_id" class="p-3 rounded-lg flex items-center justify-between" :class="{'bg-green-100/80 dark:bg-green-900/30': task.status === 'completed', 'bg-red-100/80 dark:bg-red-900/30': task.status === 'failed'}">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" class="form-checkbox h-5 w-5 rounded text-blue-600 bg-transparent" :value="task.task_id" v-model="selectedTasks">
                            <div class="truncate">
                                <p class="font-semibold">{{ getTaskFilename(task) }}</p>
                                <p class="text-xs" :class="{'text-green-600 dark:text-green-400': task.status === 'completed', 'text-red-600 dark:text-red-400': task.status === 'failed'}">
                                    {{ task.status === 'completed' ? 'å·²å®Œæˆ' : 'å¤±æ•—' }} - {{ new Date(task.updated_at).toLocaleString() }}
                                </p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                           <button @click="previewTask = task" class="p-1.5 hover:bg-gray-500/10 rounded-md transition-colors"><i data-lucide="file-text" class="w-5 h-5"></i></button>
                           <a :href="'/api/download/' + task.task_id" download class="p-1.5 hover:bg-gray-500/10 rounded-md transition-colors"><i data-lucide="download-cloud" class="w-5 h-5"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³æ™‚è½‰éŒ„è¼¸å‡º -->
        <div v-if="isProcessing" class="phoenix-glass rounded-xl p-4 sm:p-6">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
                <i data-lucide="file-text" class="w-6 h-6"></i>å³æ™‚è½‰éŒ„è¼¸å‡º
            </h2>
            <div class="w-full min-h-[100px] text-base whitespace-pre-wrap text-gray-700 dark:text-gray-300 p-2 bg-white/50 dark:bg-black/20 rounded-md">
                {{ liveTranscript || 'ç­‰å¾…ä»»å‹™é–‹å§‹...' }}
            </div>
        </div>

        <!-- é è¦½ Modal -->
        <div v-if="previewTask" @click.self="previewTask = null" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 transition-opacity" :class="previewTask ? 'opacity-100' : 'opacity-0 pointer-events-none'">
            <div @click.stop class="w-full max-w-3xl phoenix-glass rounded-xl shadow-2xl p-6 space-y-4 transform transition-transform" :class="previewTask ? 'scale-100' : 'scale-95'">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold truncate">é è¦½: {{ getTaskFilename(previewTask) }}</h3>
                    <button @click="previewTask = null" class="p-1.5 hover:bg-gray-500/20 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="w-full h-96 overflow-y-auto bg-white/50 dark:bg-black/20 p-4 rounded-lg border border-gray-400/30">
                    <pre class="whitespace-pre-wrap text-sm">{{ previewTask.result?.transcript || 'æ²’æœ‰å¯ç”¨çš„è½‰éŒ„æ–‡å­—ã€‚' }}</pre>
                </div>
                <div class="flex justify-end gap-3">
                    <button @click="previewTask = null" class="px-4 py-2 font-semibold rounded-lg bg-gray-500/20 hover:bg-gray-500/30 transition-colors">é—œé–‰</button>
                    <a :href="'/api/download/' + previewTask.task_id" download class="px-4 py-2 font-semibold rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition-colors flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        ä¸‹è¼‰
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, reactive, computed, onMounted, onUnmounted, watch } = Vue;

        createApp({
            setup() {
                // --- éŸ¿æ‡‰å¼ç‹€æ…‹ (State) ---
                const tasks = reactive({});
                const systemStats = reactive({
                    cpu_usage: 0.0,
                    ram_usage: 0.0,
                    gpu_usage: null,
                    gpu_name: null,
                    gpu_detected: false
                });
                const appStatus = reactive({
                    message: "æ­£åœ¨åˆå§‹åŒ–...",
                    model_loaded: false,
                    active_model: null
                });

                const previewTask = ref(null);
                const selectedTasks = ref(new Set());
                const selectedModel = ref('medium');
                const selectedLanguage = ref('zh');
                const uploadedFiles = ref([]);
                const liveTranscript = ref('');
                const baseFontSize = ref(100);

                let statsInterval, tasksInterval;

                // --- è¨ˆç®—å±¬æ€§ (Computed) ---
                const isProcessing = computed(() => {
                    return Object.values(tasks).some(t => ['processing', 'pending'].includes(t.status));
                });

                const globalStatus = computed(() => {
                    if (isProcessing.value) return { light: 'status-yellow', text: 'è™•ç†ä¸­...' };
                    if (appStatus.model_loaded) return { light: 'status-green', text: 'æº–å‚™å°±ç·’' };
                    return { light: 'status-red', text: 'åˆå§‹åŒ–ä¸­' };
                });

                const ongoingTasks = computed(() => {
                    return Object.values(tasks)
                        .filter(t => ['pending', 'processing'].includes(t.status))
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                });

                const completedTasks = computed(() => {
                    return Object.values(tasks)
                        .filter(t => ['completed', 'failed'].includes(t.status))
                        .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                });

                // --- API å‘¼å«æ–¹æ³• (Methods) ---
                const pollSystemStats = async () => {
                    try {
                        const response = await fetch('/api/system_stats');
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();
                        systemStats.cpu_usage = data.cpu_usage;
                        systemStats.ram_usage = data.ram_usage;
                        systemStats.gpu_usage = data.gpu_usage;
                        systemStats.gpu_detected = data.gpu_detected;
                    } catch (error) {
                        console.error("ç„¡æ³•ç²å–ç³»çµ±ç‹€æ…‹:", error);
                    }
                };

                const pollTasks = async () => {
                    try {
                        const response = await fetch('/api/tasks');
                        if (!response.ok) throw new Error('Network response was not ok');
                        const remoteTasks = await response.json();

                        // æ›´æ–°æœ¬åœ°çš„ tasks ç‰©ä»¶
                        const remoteTaskIds = new Set();
                        for (const task of remoteTasks) {
                            tasks[task.task_id] = task;
                            remoteTaskIds.add(task.task_id);
                        }
                        // åˆªé™¤é ç«¯å·²ä¸å­˜åœ¨çš„ä»»å‹™
                        for (const localTaskId in tasks) {
                            if (!remoteTaskIds.has(localTaskId)) {
                                delete tasks[localTaskId];
                            }
                        }
                    } catch (error) {
                        console.error("ç„¡æ³•ç²å–ä»»å‹™åˆ—è¡¨:", error);
                    }
                };

                const handleFileUpload = (event) => {
                    uploadedFiles.value.push(...event.target.files);
                    event.target.value = ''; // æ¸…ç©º input ä»¥ä¾¿å¯ä»¥å†æ¬¡ä¸Šå‚³åŒä¸€å€‹æª”æ¡ˆ
                };

                const startProcessing = async () => {
                    if (uploadedFiles.value.length === 0) return;

                    const filesToUpload = [...uploadedFiles.value];
                    uploadedFiles.value = []; // æ¸…ç©ºå¾…ä¸Šå‚³åˆ—è¡¨

                    for (const file of filesToUpload) {
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('model_size', selectedModel.value);
                        formData.append('language', selectedLanguage.value);

                        try {
                            const response = await fetch('/api/transcribe', {
                                method: 'POST',
                                body: formData,
                            });
                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.detail || 'ä¸Šå‚³å¤±æ•—');
                            }
                            // ç«‹å³è§¸ç™¼ä¸€æ¬¡ä»»å‹™æ›´æ–°
                            await pollTasks();
                        } catch (error) {
                            console.error(`æª”æ¡ˆ ${file.name} ä¸Šå‚³å¤±æ•—:`, error);
                            // å¯ä»¥åœ¨é€™è£¡åŠ å…¥ UI æç¤º
                        }
                    }
                };

                // --- UI/è¼”åŠ©æ–¹æ³• ---
                const changeFontSize = (amount) => {
                    const newSize = baseFontSize.value + amount;
                    if (newSize >= 50 && newSize <= 150) {
                        baseFontSize.value = newSize;
                    }
                };

                const getTaskFilename = (task) => {
                    try {
                        const path = task.payload?.input_file || '';
                        return path.split(/[\\/]/).pop();
                    } catch {
                        return 'æœªçŸ¥æª”æ¡ˆ';
                    }
                };

                watch(ongoingTasks, (newTasks, oldTasks) => {
                    const latestTask = newTasks[0];
                    if (latestTask && latestTask.status === 'processing') {
                         if (latestTask.result && latestTask.result.transcript) {
                            liveTranscript.value = latestTask.result.transcript;
                         } else {
                            liveTranscript.value = "æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹ç¨å€™...";
                         }
                    } else if (newTasks.length === 0) {
                        liveTranscript.value = "æ‰€æœ‰ä»»å‹™å·²å®Œæˆã€‚";
                    }
                });

                // --- ç”Ÿå‘½é€±æœŸé‰¤å­ (Lifecycle Hooks) ---
                onMounted(() => {
                    lucide.createIcons();

                    // ç«‹å³åŸ·è¡Œä¸€æ¬¡ï¼Œç„¶å¾Œè¨­å®šå®šæ™‚å™¨
                    pollSystemStats();
                    pollTasks();
                    statsInterval = setInterval(pollSystemStats, 2000); // 2ç§’æ›´æ–°ä¸€æ¬¡ç³»çµ±ç‹€æ…‹
                    tasksInterval = setInterval(pollTasks, 1000); // 1ç§’æ›´æ–°ä¸€æ¬¡ä»»å‹™åˆ—è¡¨

                    // ç›£è½ DOM è®ŠåŒ–ï¼Œé‡æ–°æ¸²æŸ“ lucide-icons
                    const observer = new MutationObserver(() => {
                        lucide.createIcons();
                    });
                    observer.observe(document.getElementById('app'), { childList: true, subtree: true });

                    onUnmounted(() => {
                        clearInterval(statsInterval);
                        clearInterval(tasksInterval);
                        observer.disconnect();
                    });
                });

                // --- è¿”å›çµ¦æ¨¡æ¿çš„è³‡æ–™å’Œå‡½å¼ ---
                return {
                    tasks,
                    systemStats,
                    appStatus,
                    previewTask,
                    selectedTasks,
                    selectedModel,
                    selectedLanguage,
                    uploadedFiles,
                    liveTranscript,
                    baseFontSize,
                    isProcessing,
                    globalStatus,
                    ongoingTasks,
                    completedTasks,
                    handleFileUpload,
                    startProcessing,
                    changeFontSize,
                    getTaskFilename
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
