<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音訊轉錄儀</title>
    <style>
        :root {
            --bg-color: #F8F9FA; --text-color: #202124; --card-bg-color: rgba(255, 255, 255, 0.85);
            --card-border-color: #e0e0e0; --button-bg-color: #007bff; --button-hover-bg-color: #0056b3;
            --disabled-bg-color: #ccc; --progress-bar-bg: #e9ecef; --success-color: #28a745;
            --status-green: #28a745; --status-yellow: #ffc107;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background-color: var(--bg-color); color: var(--text-color); padding: 20px; font-size: 100%; line-height: 1.5;
        }
        .container { max-width: 1200px; margin: auto; display: flex; flex-direction: column; gap: 24px; }
        .card {
            border: 1px solid var(--card-border-color); border-radius: 12px; padding: 24px;
            background-color: var(--card-bg-color); backdrop-filter: blur(10px); box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .grid-2-col { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media (min-width: 768px) { .grid-2-col { grid-template-columns: 1fr 1fr; } }
        h1 { font-size: 1.8em; font-weight: 700; }
        h2 { font-size: 1.3em; font-weight: 600; margin-bottom: 12px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        button:hover:not(:disabled) { background-color: var(--button-hover-bg-color); transform: translateY(-1px); }
        button:disabled { background-color: var(--disabled-bg-color); cursor: not-allowed; transform: none; }
        .file-drop-zone {
            border: 2px dashed #ccc; border-radius: 12px; padding: 30px; text-align: center;
            cursor: pointer; transition: background-color 0.2s, border-color 0.2s;
        }
        .hidden { display: none; }
        .progress-container {
            width: 100%; background-color: var(--progress-bar-bg); border-radius: 8px; margin-top: 16px;
            overflow: hidden; position: relative; height: 28px; display: flex; align-items: center;
        }
        .progress-bar { height: 100%; width: 0%; background-color: var(--button-bg-color); transition: width 0.2s ease-in-out; }
        .progress-text { position: absolute; width: 100%; text-align: center; color: var(--text-color); font-weight: 600; line-height: 28px; }
        .task-list { min-height: 60px; max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        .task-item { padding: 12px; border-radius: 8px; background-color: #f9f9f9; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .task-filename { font-weight: 600; }
        .task-status { font-size: 0.9em; font-weight: 500; color: #666; }
        .task-list .task-actions a {
            text-decoration: none; padding: 5px 12px; border-radius: 6px; color: white;
            font-size: 0.9em; transition: all 0.2s; display: inline-block; border: none;
            font-weight: 500; text-align: center;
        }
        .task-list .btn-preview { background-color: var(--button-bg-color); }
        .task-list .btn-download { background-color: var(--success-color); }
        .transcript-output p { margin: 0 0 0.5em 0; line-height: 1.6; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <header class="card" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;"><h1>音訊轉錄儀</h1></header>
        <div class="card">
            <h2>📊 全域儀表板</h2>
            <div class="dashboard-grid">
                <div class="stat-item"><strong>狀態:</strong> <span id="status-text">準備就緒</span></div>
                <div class="stat-item"><strong>模型:</strong> <span id="model-display">medium</span></div>
            </div>
        </div>
        <div id="local-file-tab" class="tab-content active">
            <div class="grid-2-col">
                 <div class="card flex-col">
                    <h2>⚙️ 步驟 1: 選項 (Whisper 模型)</h2>
                    <div>
                        <label for="model-select">模型大小</label>
                        <select id="model-select">
                            <option value="tiny">Tiny (最快)</option>
                            <option value="base">Base</option>
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium (建議)</option>
                            <option value="large-v2">Large-v2 (準確)</option>
                            <option value="large-v3">Large-v3 (最準確)</option>
                        </select>
                    </div>
                    <div>
                        <label for="language-select">轉錄語言</label>
                        <select id="language-select">
                            <option value="zh">繁體中文</option>
                            <option value="en">英文</option>
                        </select>
                    </div>
                    <div>
                        <label for="beam-size-input" style="display: block; margin-bottom: 4px;">光束大小 (Beam Size)</label>
                        <input type="number" id="beam-size-input" value="5" min="1" max="10" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;">
                        <small style="font-size: 0.8em; color: #666;">建議值為 5。較大的值可能更準確但較慢。</small>
                    </div>
                    <button id="confirm-settings-btn">✓ 確認設定</button>
                    <div id="model-progress-container" class="progress-container hidden" style="margin-top: 10px;">
                        <div id="model-progress-bar" class="progress-bar"></div>
                        <span id="model-progress-text" class="progress-text"></span>
                    </div>
                </div>
                <div class="card flex-col">
                    <h2>📤 步驟 2: 上傳檔案</h2>
                    <label for="file-input" class="file-drop-zone">
                        點擊此處選擇檔案
                    </label>
                    <input id="file-input" type="file" multiple class="hidden">
                    <div id="file-list"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 24px;"><button id="start-processing-btn" disabled>✨ 請先選擇檔案</button></div>
        </div>
        <div class="grid-2-col">
            <div class="card"><h2>🔄 進行中</h2><div id="ongoing-tasks" class="task-list"><p id="no-ongoing-task-msg">暫無</p></div></div>
            <div class="card"><h2>✅ 已完成</h2><div id="completed-tasks" class="task-list"><p id="no-completed-task-msg">暫無</p></div></div>
        </div>
        <div id="transcript-container" class="card"><h2>📝 即時輸出</h2><div id="transcript-output" class="transcript-output">等待任務...</div></div>
        <div id="preview-area" class="card hidden"><h2>📄 預覽</h2><button id="close-preview-btn">關閉</button><pre id="preview-content-text" class="transcript-output"></pre></div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const fileInput = document.getElementById('file-input');
            const fileListDisplay = document.getElementById('file-list');
            const startBtn = document.getElementById('start-processing-btn');
            const confirmBtn = document.getElementById('confirm-settings-btn');
            const modelSelect = document.getElementById('model-select');
            const languageSelect = document.getElementById('language-select');
            const beamSizeInput = document.getElementById('beam-size-input');
            const ongoingTasksContainer = document.getElementById('ongoing-tasks');
            const completedTasksContainer = document.getElementById('completed-tasks');
            const noOngoingTaskMsg = document.getElementById('no-ongoing-task-msg');
            const noCompletedTaskMsg = document.getElementById('no-completed-task-msg');
            const transcriptOutput = document.getElementById('transcript-output');
            const modelDisplay = document.getElementById('model-display');
            const statusText = document.getElementById('status-text');
            const modelProgressContainer = document.getElementById('model-progress-container');
            const modelProgressBar = document.getElementById('model-progress-bar');
            const modelProgressText = document.getElementById('model-progress-text');
            const previewArea = document.getElementById('preview-area');
            const previewContentText = document.getElementById('preview-content-text');
            const closePreviewBtn = document.getElementById('close-preview-btn');

            let uploadedFiles = [];
            let socket;
            const taskElements = new Map();
            const modelStatus = {};

            const setupWebSocket = () => {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/api/ws`;
                socket = new WebSocket(wsUrl);
                socket.onopen = () => { console.log('DEBUG: WebSocket connected.'); statusText.textContent = '已連線'; };
                socket.onmessage = (event) => { console.log('DEBUG: WebSocket message received:', event.data); handleWebSocketMessage(JSON.parse(event.data)); };
                socket.onclose = () => { console.log('DEBUG: WebSocket closed.'); statusText.textContent = '已離線'; setTimeout(setupWebSocket, 3000); };
            };

            const handleWebSocketMessage = (message) => {
                console.log("DEBUG: handleWebSocketMessage logic started for message:", message);
                const { type, payload } = message;
                if (type === 'DOWNLOAD_STATUS') {
                    console.log("DEBUG: Handling DOWNLOAD_STATUS");
                    modelProgressContainer.classList.remove('hidden');
                    if (payload.status === 'downloading') {
                        modelProgressBar.style.width = `${payload.progress || 0}%`;
                        modelProgressText.textContent = `下載中...`;
                    } else if (payload.status === 'completed') {
                        modelProgressBar.style.width = '100%';
                        modelProgressText.textContent = '下載完成';
                        console.log("DEBUG: Model download complete text set.");
                    }
                } else if (payload && payload.task_id) {
                    const taskElement = taskElements.get(payload.task_id);
                    if (!taskElement) {
                        console.error(`DEBUG: Could not find taskElement for task_id: ${payload.task_id}`);
                        return;
                    }
                    const statusSpan = taskElement.querySelector('.task-status');
                    if (type === 'TRANSCRIPTION_STATUS') {
                        console.log(`DEBUG: Handling TRANSCRIPTION_STATUS, status: ${payload.status}`);
                        if (payload.status === 'starting') {
                            statusSpan.textContent = '轉錄中...';
                            transcriptOutput.innerHTML = `<h3>${payload.filename}</h3>`;
                        } else if (payload.status === 'completed') {
                            console.log("DEBUG: Task is completed. Moving element to completed list.");
                            statusSpan.innerHTML = '';
                            const actions = document.createElement('div');
                            actions.className = 'task-actions';
                            const previewBtn = document.createElement('a');
                            previewBtn.href = '#';
                            previewBtn.className = 'btn-preview';
                            previewBtn.textContent = '預覽';
                            previewBtn.onclick = (e) => { e.preventDefault(); previewContentText.textContent = payload.result.transcript; previewArea.classList.remove('hidden'); };
                            actions.appendChild(previewBtn);
                            statusSpan.appendChild(actions);
                            completedTasksContainer.appendChild(taskElement);
                            noCompletedTaskMsg.style.display = 'none';
                            console.log("DEBUG: Element moved.");
                        }
                    } else if (type === 'TRANSCRIPTION_UPDATE') {
                        const p = document.createElement('p');
                        p.textContent = `[${payload.start.toFixed(2)}s -> ${payload.end.toFixed(2)}s] ${payload.text}`;
                        transcriptOutput.appendChild(p);
                    }
                }
            };

            const updateFileDisplay = () => {
                fileListDisplay.innerHTML = '';
                uploadedFiles.forEach((file, index) => {
                    const el = document.createElement('div');
                    el.className = 'task-item';
                    el.innerHTML = `<span class="task-filename">${file.name}</span><button data-index="${index}">移除</button>`;
                    el.querySelector('button').onclick = () => { uploadedFiles.splice(index, 1); updateFileDisplay(); };
                    fileListDisplay.appendChild(el);
                });
                startBtn.disabled = uploadedFiles.length === 0;
                startBtn.textContent = `✨ 開始處理 ${uploadedFiles.length} 個檔案`;
            };

            fileInput.addEventListener('change', () => {
                uploadedFiles.push(...Array.from(fileInput.files));
                updateFileDisplay();
                fileInput.value = '';
            });

            confirmBtn.addEventListener('click', () => {
                console.log("DEBUG: Confirm Settings button clicked.");
                modelDisplay.textContent = modelSelect.value;
                if (socket) {
                    console.log("DEBUG: Sending DOWNLOAD_MODEL message via WebSocket.");
                    socket.send(JSON.stringify({ type: 'DOWNLOAD_MODEL', payload: { model: modelSelect.value } }));
                }
            });

            startBtn.addEventListener('click', async () => {
                console.log("DEBUG: Start Processing button clicked.");
                startBtn.disabled = true;
                for (const file of uploadedFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('model_size', modelSelect.value);
                    formData.append('language', languageSelect.value);
                    formData.append('beam_size', beamSizeInput.value);

                    const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
                    const result = await res.json();
                    console.log("DEBUG: Received response from /api/transcribe:", result);
                    const tasks = Array.isArray(result.tasks) ? result.tasks : [result];

                    tasks.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.className = 'task-item';
                        taskElement.innerHTML = `<span class="task-filename">${file.name} (${task.type})</span><span class="task-status">已建立</span>`;
                        ongoingTasksContainer.appendChild(taskElement);
                        taskElements.set(task.task_id, taskElement);
                        // 如果是轉錄任務（在多任務情況下 type 為 'transcribe'，或在單任務情況下 result.tasks 不存在），則啟動它
                        if (socket && (task.type === 'transcribe' || !result.tasks)) {
                            console.log(`DEBUG: Sending START_TRANSCRIPTION for task_id: ${task.task_id}`);
                            socket.send(JSON.stringify({ type: 'START_TRANSCRIPTION', payload: { task_id: task.task_id } }));
                        }
                    });
                }
                uploadedFiles = [];
                updateFileDisplay();
            });

            closePreviewBtn.addEventListener('click', () => previewArea.classList.add('hidden'));
            setupWebSocket();
            updateFileDisplay();
        });
    </script>
</body>
</html>
