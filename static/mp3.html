<!DOCTYPE html>
<html lang="zh-Hant" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鳳凰音訊轉錄儀 v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .dark body { background-color: #131316; color: #E8EAED; }
        body { background-color: #F8F9FA; color: #202124; }
        .phoenix-glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(0, 0, 0, 0.1); }
        .dark .phoenix-glass { background: rgba(32, 33, 36, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }
        .phoenix-gradient-text { background: linear-gradient(90deg, #89CFF0, #A688FA, #F482A4); -webkit-background-clip: text; background-clip: text; color: transparent; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <div id="app" class="max-w-7xl mx-auto space-y-6" v-cloak>
        <!-- 標題 -->
        <header class="flex justify-between items-center">
            <h1 class="text-2xl font-bold">鳳凰 <span class="phoenix-gradient-text">音訊轉錄儀 v2</span></h1>
        </header>

        <!-- 頂部：指揮中心 -->
        <div id="status-dashboard" class="phoenix-glass rounded-xl p-4 sm:p-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <!-- 左側：狀態燈 -->
                <div class="flex items-center gap-4">
                    <h2 class="text-xl font-bold">指揮中心</h2>
                    <div class="flex items-center gap-2">
                        <span class="flex h-3 w-3 rounded-full" :class="getTrafficLightClass(appStatus.system_ready)" title="系統狀態"></span>
                        <span class="flex h-3 w-3 rounded-full" :class="getTrafficLightClass(appStatus.model_loaded)" title="模型狀態"></span>
                        <span class="flex h-3 w-3 rounded-full" :class="getTrafficLightClass(appStatus.gpu_detected)" title="GPU 加速"></span>
                    </div>
                </div>
                <!-- 中間：狀態訊息 -->
                <div class="flex-grow text-center">
                    <p class="font-semibold">{{ appStatus.message }}</p>
                </div>
                <!-- 右側：系統資源 -->
                <div class="flex items-center gap-4 text-sm">
                    <span>CPU: {{ systemStats.cpu_usage.toFixed(1) }}%</span>
                    <span>RAM: {{ systemStats.ram_usage.toFixed(1) }}%</span>
                    <span v-if="appStatus.gpu_detected">GPU: {{ systemStats.gpu_usage !== null ? systemStats.gpu_usage.toFixed(1) + '%' : 'N/A' }}</span>
                    <span class="text-xs text-gray-500">(每 0.3 秒更新)</span>
                </div>
            </div>
        </div>

        <!-- 中部：控制面板 -->
        <div id="control-panel" class="phoenix-glass rounded-xl p-4 sm:p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- 模型選擇 -->
                <div>
                    <label for="model-select" class="block text-sm font-medium mb-1">1. 選擇模型</label>
                    <select id="model-select" v-model="selectedModel" class="w-full p-2 rounded-md bg-white/60 dark:bg-black/30 border border-gray-400/50 dark:border-gray-600/50 focus:ring-2 focus:ring-sky-500">
                        <option value="tiny">Tiny (最快)</option>
                        <option value="base">Base</option>
                        <option value="small">Small</option>
                        <option value="medium">Medium (建議)</option>
                        <option value="large">Large (最準確)</option>
                    </select>
                </div>
                <!-- 語言選擇 -->
                <div>
                    <label for="language-select" class="block text-sm font-medium mb-1">2. 選擇語言</label>
                    <select id="language-select" v-model="selectedLanguage" class="w-full p-2 rounded-md bg-white/60 dark:bg-black/30 border border-gray-400/50 dark:border-gray-600/50 focus:ring-2 focus:ring-sky-500">
                        <option value="zh">繁體中文</option>
                        <option value="en">英文</option>
                    </select>
                </div>
                <!-- 上傳與開始 -->
                <div>
                    <label class="block text-sm font-medium mb-1">3. 上傳檔案並開始</label>
                    <label for="file-input" class="w-full px-4 py-2 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 transition-colors flex items-center justify-center gap-2 cursor-pointer">
                        <i data-lucide="play-circle" class="w-5 h-5"></i>
                        <span>開始處理</span>
                    </label>
                    <input id="file-input" type="file" multiple class="hidden" @change="handleFileUpload">
                </div>
            </div>
        </div>

        <!-- 底部：結果區域 -->
        <div id="results-area" v-if="true" class="phoenix-glass rounded-xl p-4 sm:p-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- 左側：已完成檔案列表 -->
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">已完成檔案</h2>
                        <button class="text-sm font-semibold flex items-center gap-2 px-3 py-1.5 rounded-md bg-blue-600 text-white disabled:bg-gray-400">
                            <i data-lucide="download" class="w-4 h-4"></i>
                            <span>下載已選 (0)</span>
                        </button>
                    </div>
                    <div class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Placeholder for completed files -->
                        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                           <p>尚無完成的任務</p>
                        </div>
                    </div>
                </div>
                <!-- 右側：預覽/即時字幕 -->
                <div>
                     <h2 class="text-xl font-semibold mb-4">預覽</h2>
                     <div class="aspect-video bg-black/20 rounded-lg p-4 text-gray-400">
                        <p>點擊左側檔案旁的 <i data-lucide="file-text" class="inline-block w-4 h-4"></i> 按鈕以預覽結果。</p>
                        <br>
                        <p>處理中任務的即時字幕也會顯示於此處。</p>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, reactive, computed, onMounted, onUnmounted } = Vue;

        createApp({
            setup() {
                // --- 狀態儀表板響應式狀態 ---
                const appStatus = reactive({
                    system_ready: false,
                    model_loaded: false,
                    gpu_detected: false,
                    message: "正在初始化..."
                });
                const systemStats = reactive({
                    cpu_usage: 0,
                    ram_usage: 0,
                    gpu_usage: null
                });

                // --- 控制面板響應式狀態 ---
                const selectedModel = ref('medium');
                const selectedLanguage = ref('zh');

                // --- 結果區域響應式狀態 ---
                const tasks = reactive({}); // 用於儲存所有任務，包括下載和轉錄
                const previewContent = ref(""); // 用於右側面板顯示的內容
                const selectedFilesForDownload = ref(new Set());

                // --- Polling 間隔 ---
                let statsInterval, appStatusInterval, tasksInterval;

                // --- Computed Properties for UI ---
                const completedTranscriptionTasks = computed(() => {
                    return Object.values(tasks)
                        .filter(t => t.type === 'transcribe' && t.status === 'COMPLETED')
                        .sort((a, b) => b.startTime - a.startTime);
                });

                const isProcessing = computed(() => {
                    return Object.values(tasks).some(t => t.status === 'PROCESSING');
                });

                // --- UI 邏輯函式 ---
                const getTrafficLightClass = (status) => status ? 'bg-green-500' : 'bg-gray-400';

                // --- 核心邏輯函式 ---
                const pollSystemStats = async () => {
                    try {
                        const response = await fetch('/api/system_stats');
                        if (response.ok) {
                            const data = await response.json();
                            systemStats.cpu_usage = data.cpu_usage;
                            systemStats.ram_usage = data.ram_usage;
                            systemStats.gpu_usage = data.gpu_usage;
                            appStatus.gpu_detected = data.gpu_detected;
                            appStatus.system_ready = true; // 收到第一次回應即表示系統就緒
                        }
                    } catch (e) {
                        console.error("無法獲取系統狀態:", e);
                        appStatus.system_ready = false;
                    }
                };

                // TODO: 實作 pollAppStatus 和 pollTasks

                const handleFileUpload = async (event) => {
                    // TODO: 實作檔案上傳和任務建立邏輯
                };

                const showPreview = (task) => {
                    // TODO: 實作預覽邏輯
                };

                const downloadSelectedFiles = () => {
                    // TODO: 實作下載邏輯
                };


                // --- 生命週期掛鉤 ---
                onMounted(() => {
                    statsInterval = setInterval(pollSystemStats, 300);
                    pollSystemStats();

                    lucide.createIcons();
                    const observer = new MutationObserver(() => {
                        lucide.createIcons();
                    });
                    observer.observe(document.getElementById('app'), { childList: true, subtree: true });

                    onUnmounted(() => {
                        observer.disconnect();
                        clearInterval(statsInterval);
                        // TODO: 清除其他計時器
                    });
                });

                // --- 返回給模板的資料和函式 ---
                return {
                    appStatus,
                    systemStats,
                    selectedModel,
                    selectedLanguage,
                    completedTranscriptionTasks,
                    isProcessing,
                    previewContent,
                    selectedFilesForDownload,
                    getTrafficLightClass,
                    handleFileUpload,
                    showPreview,
                    downloadSelectedFiles
                };
            }
        }).mount('#app');


    </script>
</body>
</html>
