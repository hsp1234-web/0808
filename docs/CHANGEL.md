# 鳳凰之心 - 專案變更日誌

## V69 (2025-08-14) - 後端狀態持久化與前端穩定性修復

*   **目標**: 徹底解決使用者在重新整理頁面後，所有輸入和設定都會遺失的問題。透過實作一個由後端驅動的狀態保存機制，確保使用者體驗的連續性。同時，修復在實作過程中意外引入的、導致整個頁面凍結的嚴重 BUG。
*   **核心變更**:
    1.  **後端狀態儲存架構**:
        *   **資料庫擴充 (`database.py`)**: 在 `tasks.db` 中新增了一個名為 `app_state` 的鍵值對(key-value)資料表，專門用於儲存 UI 狀態。
        *   **服務層擴充 (`manager.py`, `client.py`)**: 擴充了資料庫管理器與客戶端，加入了 `get_app_state` 和 `set_app_state` 的功能，確保狀態讀寫遵循現有的 TCP 伺服器架構。
        *   **API 層擴充 (`api_server.py`)**: 新增了 `GET /api/app_state` 和 `POST /api/app_state` 兩個 API 端點，供前端進行狀態的讀取與儲存。
    2.  **前端載入邏輯修復**:
        *   **問題**: 初版實作中，在頁面載入初期就 `await` (等待) 後端狀態，導致在後端服務尚未完全就緒時，阻塞了整個頁面的渲染和事件綁定，造成畫面凍結。
        *   **修復**: 重新設計了 `mp3.html` 的載入流程。現在頁面會先完成所有 UI 元件的渲染和事件綁定，確保頁面可立即互動，然後才以「非同步、非阻塞」的方式向後端請求狀態資料並更新 UI。此修改從根本上解決了頁面凍結問題。
    3.  **測試環境修復**:
        *   建立了 `logs/` 目錄，解決了 `circus` 程序管理器因找不到日誌路徑而無法啟動後端服務的問題，使得 E2E 測試能夠順利執行。
*   **成果**: 本次更新成功交付了一個使用者期待已久的關鍵功能，並修復了一個嚴重的體驗問題。現在，應用程式能夠安全地保存使用者的工作進度，顯著提升了產品的穩定性和實用性。

---

## V68 (2025-08-07) - 看門狗啟動器與文件體系同步

*   **目標**: 開發一個通用的安全啟動器以監控背景服務的健康狀態，並對專案的技術文件進行全面更新，確保其準確性和時效性。
*   **核心變更**:
    1.  **新增 `scripts/safe_runner.py`**:
        *   交付了一個全新的、帶有看門狗功能的安全啟動器。
        *   此腳本可以監控任何子進程的日誌輸出，並在子進程於指定時間內無響應時，自動將其終止，從根本上防止了服務「假死」或「掛起」的問題。
        *   其設計與實作，嚴格遵循了 `experience.md` 中沉澱的「隔離驗證」與「多執行緒監控」的最佳實踐。
    2.  **修復 E2E 測試套件**:
        *   在為新功能進行驗證時，發現並修復了既有 E2E 測試 (`test_full_system_flow.py`) 中因資料庫未被及時初始化而導致的 `no such table` 錯誤。
    3.  **全面文件更新**:
        *   **`TEST.md`**: 更新了 E2E 測試的檔案名稱和執行測試所需的前置要求。
        *   **`ARCHITECTURE.md`**: 在目錄結構中新增了對 `safe_runner.py` 的說明。
        *   **`MISSION_DEBRIEFING.md`**: 新增了本次 V68 任務的完整復盤記錄。
        *   **`experience.md`**: 更新了「看門狗機制」的條目，將其標示為【已處理】，並指向新的 `safe_runner.py` 實現。
*   **成果**: 本次更新不僅交付了一個關鍵的穩定性功能，還透過修復測試和同步文件，顯著提升了專案的整體健康度和可維護性。

---

## V66 (2025-08-06) - `local_run.py` 健壯性與除錯流程強化

*   **目標**: 針對 `local_run.py` 腳本進行全面強化，提升其日誌清晰度、看門狗的可靠性，並修復一系列在偵錯過程中發現的、潛藏的環境設定與啟動流程的深層次 BUG。
*   **核心變更**:
    1.  **升級日誌系統 (`local_run.py`)**:
        *   將腳本中所有的 `print` 陳述式替換為 Python 標準的 `logging` 模組，為每一行日誌都加上了精確的時間戳和日誌級別，極大提升了除錯效率。
    2.  **強化看門狗邏輯 (`local_run.py`)**:
        *   將看門狗的健康檢查邏輯，從單純「檢查資料庫檔案是否存在」，升級為「直接連線資料庫，查詢 `last_heartbeat` 時間戳是否在持續更新」。這是一個更真實、更可靠的「心跳檢查」。
    3.  **修復核心啟動器BUG (`scripts/launch.py`)**:
        *   根據 `BUG.md` 的歷史經驗，將 `launch.py` 中 `run_sync_command` 函式內的 `subprocess.Popen` 呼叫替換為 `subprocess.run`。這解決了在受限沙箱環境中，`Popen` 會導致腳本「無聲掛起」的嚴重問題，確保了環境設定流程的穩定執行。
    4.  **修復測試框架 (`tests/`)**:
        *   修復了 `tests/system_health_check.py` 中因日誌訊息變更和日誌捕獲方式不正確 (`capsys` vs `caplog`) 而導致的測試失敗問題。
        *   確保了開發依賴 (`requirements/dev.txt`) 被正確安裝，使得測試能夠在虛擬環境中順利執行。
*   **成果**: 經過這次強化與修復，`local_run.py` 成為了一個更專業、更可靠的開發與 CI/CD 工具。整個偵錯與修復過程也被詳細記錄在 `BUG.MD` 中，為專案的知識庫增加了寶貴的實戰案例。

---

## V65 (2025-08-05) - 核心啟動器架構重構與穩定性強化

*   **目標**: 徹底解決本地 (`local_run.py`) 與 Colab (`colab_runner.py`) 之間因環境設定邏輯不一致而導致的執行差異與一系列連鎖錯誤。透過引入單一事實來源的「核心啟動器」，確保在任何環境下都有一致、可靠的執行流程。

*   **核心變更**:
    1.  **建立 `scripts/launch.py`**:
        *   建立了一個全新的「核心啟動器」，它現在是負責處理所有環境設定（建立 venv、安裝依賴）和應用程式啟動的**唯一**權威腳本。
        *   此啟動器經過多輪測試與迭代修復，能夠穩定地在乾淨環境中運作，並解決了在 Colab 中因 `ensurepip` 或 `pip` 未安裝導致的底層錯誤。
    2.  **重構 `local_run.py` 和 `run/colab_runner.py`**:
        *   這兩個腳本被大幅簡化，移除了所有各自的環境設定與安裝邏輯。
        *   現在它們的唯一職責是呼叫 `scripts/launch.py`，從根本上保證了執行環境的一致性。
    3.  **建立 `tests/test_launcher.py`**:
        *   增加了一個全新的端對端整合測試，專門用於在提交前驗證核心啟動器的健壯性。
        *   此測試透過模擬 Colab 的行為（在乾淨的臨時目錄中複製工作區並執行啟動器），成功地捕捉並幫助修復了多個先前難以發現的環境設定錯誤。
    4.  **增強除錯與穩定性**:
        *   **環境探針**: 為 `scripts/launch.py` 加入了「環境探針」功能，在啟動時打印詳細的 Python/uv 版本、作業系統和路徑資訊，極大提升了遠端除錯的效率。
        *   **動態埠號選擇**: 為 `run/colab_runner.py` 實現了動態埠號尋找功能，從根本上解決了因埠號被佔用 (`Address already in use`) 而導致的啟動失敗問題。
        *   **健壯的重試邏輯**: 強化了 `colab_runner.py` 中獲取代理連結的邏輯，確保在 Colab 前後端通訊不穩定時能夠穩定重試。

*   **成果**: 這次重構從根本上解決了環境不一致的問題，並建立了一套可靠的本地驗證流程，大幅提升了專案的長期穩定性、可維護性和開發效率。

---

## V64 (2025-08-04) - 專案大規模清理與結構簡化

*   **目標**: 根據最新的開發方向，對專案進行大規模的清理，移除不再需要的模組、過時的程式碼以及臨時的除錯檔案，旨在將專案精簡至只包含運行 `colab_runner.py` 所需的核心元件。
*   **清理範圍**:
    *   **`archive/`**: 刪除了整個 `archive` 資料夾，其中包含所有舊版本的程式碼備份。
    *   **`debug/`**: 刪除了整個 `debug` 資料夾，移除了所有臨時的除錯腳本和日誌。
    *   **`src/ALLDATA/`**: 根據最終確認，移除了此資料模組，因其功能不再是核心部分。
    *   **日誌與暫存檔**: 清理了專案根目錄下所有執行時產生的 `.log` 日誌檔、`.db-shm` 和 `.db-wal` 資料庫暫存檔。
    *   **Python 快取**: 遞歸刪除了所有 `__pycache__` 資料夾和 `.pyc` 檔案，確保交付一個乾淨的原始碼結構。
*   **理由**: 這次清理是為了讓專案聚焦於其最核心的功能，減少維護成本，並為後續的開發提供一個更乾淨、更專注的基礎。

---

本文件旨在記錄「鳳凰之心」專案的重大架構變更、重構或設計理念的演進。當您對專案的歷史背景或某項特定變更的原因感到好奇時，這裡就是您的第一參考。

我們鼓勵在進行任何足以影響專案核心結構或開發流程的重大變更後，在此處留下一筆清晰的紀錄。

---

## V63 (2025-08-04) - Colab 安裝器修正與版本統一

*   **目標**: 解決在 Colab 環境中因安裝器參數錯誤導致的啟動失敗問題，並統一版本標識。
*   **實作**:
    *   **安裝器修正**: 在 `run/colab_runner.py` 中，從 `uv pip install` 指令裡移除了 `pip` 的專用參數 `--ignore-installed`。根據 `research.md` 的研究，`uv` 在指定虛擬環境的 Python 解譯器後，本身就能正確處理依賴隔離，無需此參數。
    *   **版本號統一**: 將 Colab 介面中的版本號從 `V62` 全面更新至 `V63`，包括標題、日誌註解和儀表板顯示，確保了使用者介面的一致性。

## V54 (2025-08-04) - 外觀優化
*   **目標**: 提升儀表板日誌的可讀性。
*   **實作**:
    *   **置中對齊日誌**: 在 `DisplayManager` 中，將日誌等級的 f-string 格式化從 `:<8` (靠左) 修改為 `:^8` (置中)，使儀表板的日誌輸出更加整潔美觀。
    *   **分支更新**: 將預設分支更新至 `0.7.0`。

## V50-V53 (2025-08-04) - UI/UX 與穩定性迭代
*   **目標**: 徹底解決 UI 閃爍、輸出緩衝、以及 `pip` 安裝失敗等一系列深層次的環境與執行緒問題。
*   **V53 - 單一繪製原則**:
    *   **問題**: UI 依然存在閃爍和狀態行更新延遲。
    *   **分析**: 定位到問題根源是多次 `print` 與 `clear_output` 的競爭條件。
    *   **解決方案**: 重構 `DisplayManager`，將所有待顯示內容先存入一個 buffer，最後用一次 `print` 原子性地輸出整個畫面，徹底解決問題。
*   **V52 - 輸出緩衝修正**:
    *   **問題**: 狀態行只在任務結束時才出現。
    *   **分析**: Colab 的輸出緩衝區可能需要 `\n` 來觸發刷新。
    *   **解決方案**: 在 `print(..., end='\r')` 後追加一個空的 `print()` 來強制刷新。
*   **V51 - 執行緒生命週期解耦**:
    *   **問題**: 當工作執行緒出錯時，UI 執行緒也跟著停止，導致畫面凍結。
    *   **解決方案**: 將主迴圈改為 `while True:`，確保 `DisplayManager` 能持續運行並回報最終的錯誤狀態。同時修正了 `NameError`。
*   **V50 - `pip` 引導程序修正**:
    *   **問題**: 在乾淨的 `uv venv` 環境中，`pip` 模組不存在。
    *   **解決方案**: 在 `_setup_environment` 中增加一步，使用 `uv pip install pip wheel` 為新環境手動安裝 `pip`。

## V34 - 全功能自動化偵錯腳本

**目標**: 建立一個單一的、無須人工干預的自動化偵錯腳本，用於系統性地驗證專案從程式碼下載、後端啟動、資料庫準備到核心模組功能的每一個環節，確保後端的基礎穩定性。

### 1. 建立 `debug/debug_ALL.py`
*   **核心功能**: 建立了一個新的 `debug/debug_ALL.py` 腳本，該腳本整合了五個核心驗證階段。
*   **階段一：下載通道驗證**: 透過 `git clone` 測試程式碼的下載流程。
*   **階段二：後端基礎健康檢查**: 在獨立的虛擬環境中建立、安裝依賴並啟動後端服務，使用看門狗機制監控啟動狀態。
*   **階段三：資料庫準備流程驗證**: 檢查後端 `state.db` 的生成，並模擬重命名為 `logs.sqlite` 的流程。
*   **階段四：Colab 啟動邏輯模擬**: 以無介面的方式，驗證系統狀態是否符合 Colab 啟動腳本成功執行後的預期結果。
*   **階段五：報告模組核心功能驗證**: 對 `report_generator.py` 的核心函式進行單元測試，驗證檔案的讀取與存檔邏輯。
*   **優勢**: 此腳本提供了一鍵式的健康檢查，能作為 CI/CD 或本地開發的基礎，確保專案在任何環境下的基本功能穩定可靠。

---

## V33 - 互動式報告儀表板與自動化測試

**目標**: 建立一個功能完整的互動式報告儀表板，並為其所有核心的檔案 I/O 邏輯建立 100% 的自動化單元測試，確保其在任何環境下的穩定性。

### 1. 核心邏輯開發與自動化驗證 (`src/phoenix_core/report_generator.py`)
*   **測試驅動開發**: 嚴格遵循「測試優先」原則，先為所有功能編寫 pytest 單元測試。
*   **模擬檔案系統**: 在 `tests/conftest.py` 中建立了 `mock_report_files` 樁件，它使用 `tmp_path` 在測試期間建立一個臨時的、包含假報告的虛擬檔案系統，確保了測試的獨立與乾淨。
*   **報告讀取邏輯**: 開發並驗證了 `read_selected_reports` 函式，確保其能根據使用者的選擇，精確地讀取和合併報告內容。
*   **報告存檔邏輯**: 開發並驗證了 `archive_selected_reports` 函式，確保其能將選定的報告複製到一個新的、帶有時間戳和中文目錄名稱的存檔路徑中。

### 2. Colab 互動式儀表板 (`report.py`)
*   **全新 UI**: 從零開始建立了一個基於 `ipywidgets` 的互動式儀表板 `report.py`。
*   **功能完整**:
    *   使用者可以透過勾選框，任意選擇想要查看的報告組合。
    *   點擊「產生報告」後，儀表板會呼叫後端經過驗證的 `read_selected_reports` 函式，並在輸出區域顯示報告內容。
    *   報告生成後，會顯示「複製報告」和「存檔報告」按鈕。
    *   點擊「存檔報告」，會呼叫後端經過驗證的 `archive_selected_reports` 函式，並提供操作反饋。
*   **使用者體驗**: UI 元件佈局清晰，並在按鈕操作後提供即時的視覺回饋。

### 3. 專案版本全面更新
*   **版本號統一**: 將專案中所有可見的版本號（包括 `run/colab_runner.py` 和其他文件）統一更新為 `V33`。
*   **文件同步**: 更新了本變更日誌 (`CHANGEL.md`) 和測試指南 (`TEST.md`)，以反映最新的版本和功能。

---

## V33 - 端對端測試體系建立與文件現代化

**目標**: 為專案建立一個極其健壯、全自動的端對端測試框架，並對核心腳本與技術文件進行現代化更新，以確保專案的長期品質與可維護性。

### 1. 端對端測試體系 (`tests/e2e/test_colab_logic.py`)
*   **全新 E2E 框架**: 從零開始建立了一個權威性的 E2E 測試腳本，它透過模擬 `colab_runner.py` 的核心邏輯來驗證整個後端服務的行為。
*   **自我引導環境**: 測試腳本能夠自動建立 venv、安裝依賴，並使用 venv 中的 Python 重新啟動自己，實現了在任何環境下的可靠執行。
*   **報告生成測試**: 透過在測試期間動態建立一個包含模擬資料的 `state.db`，成功地將報告生成 (`scripts/generate_report.py`) 功能納入自動化測試，解決了後端 API 尚未實作資料庫的問題。
*   **儀表板刷新率測試**: 透過將後端 API (`/api/v1/status/performance`) 從回傳假資料升級為回傳即時 `psutil` 數據，並在測試中驗證數據的變動性，間接確保了儀表板刷新功能有效。
*   **下載功能測試**: 新增了獨立的 `git clone` 測試，該測試在一個隔離的臨時目錄中進行，並在結束後自動清理，確保了測試的原子性與環境的乾淨。
*   **健壯的程序監控**: 測試流程中包含了 10 秒的看門狗計時器，以防止伺服器啟動時因意外問題卡死 CI/CD 流程。

### 2. 核心腳本更新
*   **`run/colab_runner.py`**:
    *   版本號更新至 `V33 (功能擴充版)`。
    *   預設下載分支 `TARGET_BRANCH_OR_TAG` 更新為 `0.3.0`。
*   **`run/report.py`**:
    *   版本號更新至 `V33 (測試強化版)`，並在註釋中註明已被 E2E 測試整合。

### 3. 文件體系現代化
*   **架構與指南更新**: 將過時的 `ARCHITECTURE.md` 和 `Colab_Guide.md` 檔案，用其對應的 `V2_Proposal` 版本進行了替換，使核心文件能夠準確反映當前的 API 驅動架構。
*   **測試文件重寫**: 徹底重寫了 `docs/TEST.md`，使其成為新 E2E 測試框架的權威指南，詳細介紹了其設計理念與執行細節。
*   **變更日誌更名**: 將 `docs/CHANGELOG.md` 更名為 `docs/CHANGEL.md`，並記錄了本次 `V33` 的所有變變更。

---

## V33 - 全功能 Colab UI 與可配置後端

**目標**: 在保持 V33 穩定後端啟動器架構的基礎上，將使用者最初設想的全功能 UI 介面與參數選項重新引入，並使後端能夠動態地根據這些選項進行配置，最終實現一個功能完整且穩定可靠的系統。

### 1. Colab 使用者介面 (`run/colab_runner.py`)
*   **全參數實現**: 重新加入了使用者最初要求的所有 Colab 表單參數 (`#@param`)，包括 Git 倉庫設定、應用程式參數（如更新頻率）、以及精細的日誌等級顯示控制。
*   **動態設定生成**: `colab_runner.py` 現在會根據使用者在表單中的選擇，動態生成一個結構化的 `config.json` 檔案。

### 2. 可配置的後端啟動器 (`scripts/start_api_service.py`)
*   **接收設定**: `start_api_service.py` 被重構為可以接收一個 `--config` 命令列參數，指向由前端生成的 `config.json` 檔案。
*   **環境變數傳遞**: 啟動器會將 `config.json` 的路徑設定到 `PHOENIX_CONFIG_PATH` 環境變數中，供後端應用程式讀取。
*   **移除模擬伺服器**: 徹底移除了原先在啟動器中硬編碼一個模擬 API 伺服器的邏輯，確保啟動的是真實的、完整的後端應用。

### 3. 可配置的後端核心 (`src/phoenix_core/`)
*   **Pydantic 設定升級**: 重構了 `kernel/settings.py`，使用 Pydantic 的自訂來源功能，使其能夠優先從 `PHOENIX_CONFIG_PATH` 所指向的 JSON 檔案中讀取所有巢狀設定。
*   **模組化 API**:
    *   建立了新的 `modules/status_api` 模組，專門負責提供狀態 API。
    *   採用了專案現有的自註冊路由機制 (`kernel/registry.py`)，確保了新 API 模組能被主應用自動發現並掛載。

### 4. 健壯的整合測試 (`tests/integration/colab_test.py`)
*   **從零開始的除錯**: 經歷了多次失敗，從 `ModuleNotFoundError`、`Address already in use` 到 `Connection refused`，逐步定位並解決了環境、依賴、網路和程式碼邏輯中的多個深層次問題。
*   **最佳實踐**: 最終的整合測試遵循了所有最佳實踐：
    *   **Venv 隔離**: 在臨時目錄中建立完全隔離的虛擬環境。
    *   **動態埠號**: 自動尋找並使用未被佔用的埠號來啟動伺服器，從根本上解決了埠號衝突問題。
    *   **安全安裝器**: 根據使用者要求，建立了 `utils/safe_installer.py` 和 `utils/resource_monitor.py`，並將其整合進測試流程。
    *   **穩定驗證**: 最終測試成功驗證了從 UI 參數 -> `config.json` -> 後端啟動器 -> 後端核心設定 -> API 回應的完整流程。

### 5. 文件與工具鏈
*   **檔案更名**: 根據使用者要求，將 `scripts/run_local.py` 更名為 `scripts/local_run.py`。

## V33 (進行中) - 測試架構重構與依賴清理

**目標**: 提升測試套件的可維護性與擴展性，並徹底清理舊架構的技術債，使專案技術棧 100% 統一。

### 1. 測試抽象化 (`conftest.py`)
*   **引入共享 Fixture**: 在 `tests/conftest.py` 中建立了名為 `live_api_service` 的公共測試裝置 (Fixture)。
*   **封裝複雜邏輯**: 此 Fixture 完整地封裝了「在背景啟動 Colab 後端服務、輪詢 API 直到其就緒、測試結束後自動關閉服務」的複雜流程。
*   **簡化測試案例**: 重構了 `tests/integration/test_colab_flow.py`，使其直接使用 `live_api_service` Fixture。這使得測試案例本身的程式碼大幅減少，變得極其簡潔且專注於業務邏輯驗證。

### 2. 技術債清理 (Tech Debt Cleanup)
*   **依賴純淨化**: 從核心依賴檔案 `requirements/base.in` 中徹底移除了舊的 `aiohttp` 依賴。
*   **過時測試移除**: 刪除了 `tests/integration/` 目錄下所有針對舊 `aiohttp` 伺服器編寫的測試檔案。
*   **依賴文件再生**: 執行 `pip-compile` 重新生成了所有 `requirements/*.txt` 鎖定檔案，確保依賴關係的準確與乾淨。

### 3. 文件同步 (Documentation Sync)
*   **架構文件更新**: 更新了 `docs/ARCHITECTURE_V2_Proposal.md`，新增了「測試策略」章節，詳細闡述了基於 `conftest.py` 和 Fixture 的測試架構。
*   **本變更紀錄**: 新增了此 V33 的變更紀錄。

---

## 2025-08-01: V33 - 可測試性與環境解耦重構

**目標**: 解決 V33 (API 驅動) 架構在非 Colab 環境下難以測試的問題，並對其進行全面的加固，使其具備在任何環境下都能可靠運行的能力。

### 1. 執行腳本環境解耦 (`run/*.py`)
*   **問題**: `run/colab_runner.py` 和 `run/report.py` 內含有對 `/content` 目錄的硬性路徑依賴，導致在標準測試環境中無法執行。
*   **解決方案**:
    *   重構了這兩個腳本，使其能夠透過環境變數 (`PHOENIX_CONTENT_ROOT`, `PHOENIX_PROJECT_FOLDER`, `PHOENIX_FAST_TEST_MODE`) 進行配置。
    *   這使得腳本在保持 Colab 預設行為的同時，也能在任何 CI/CD 或本地環境中，透過設定環境變數來指向臨時目錄並執行，無需修改任何原始碼。

### 2. 端對端 (E2E) 測試體系重建 (`tests/e2e/`)
*   **問題**: 舊的 E2E 測試透過在執行期間動態修改原始碼來運作，這種方式極其脆弱且不可靠。
*   **解決方案**:
    *   廢除了舊的測試，並建立了一個全新的、基於 `pytest` 的 E2E 測試 `tests/e2e/test_full_lifecycle.py`。
    *   新的測試利用在第一點中引入的環境變數來控制執行流程，確保了測試的穩定性與簡潔性。
    *   在解決了由測試沙箱中損壞的 `pip` 快取引發的一系列 `ModuleNotFoundError` 後，E2E 測試最終成功通過，完整驗證了 V33 架構的生命週期。

### 3. 核心工具鏈加固 (`src/phoenix_core/`)
*   **穩定性**: 增強了 `package_utils.py` 中的 `get_package_size` 函式，為其加入了對無效 JSON 回應的錯誤處理，防止因 PyPI API 異常而導致的崩潰。
*   **性能分析**: 在 `colab_runner.py` 的依賴安裝流程中，為「估算套件大小」和「pip 安裝」等關鍵步驟增加了計時日誌，為未來的性能優化提供了數據支持。

## 版本 0.1.0 (V33) - API 驅動架構重構

**目標**：將專案從舊的「資料庫輪詢」模式，徹底重構為現代化的「API 驅動」架構，以達成前後端的完全解耦，並提升系統的穩定性與可測試性。

### 1. 後端服務化 (`scripts/launch.py`)
*   **引入 `Aiohttp`**：`launch.py` 不再是一個執行完就退出的腳本，而是被改造為一個基於 `Aiohttp` 和 `Asyncio` 的常駐非同步 Web 服務。
*   **API 端點建立**:
    *   `GET /api/v1/status`：提供一個即時的 JSON 端點，讓任何客戶端（不僅是 Colab）都能獲取服務的當前狀態、資源使用率和日誌。
    *   `POST /api/v1/shutdown`：提供一個標準的 API 來觸發服務的優雅關機程序。
*   **狀態管理**：狀態首先在記憶體中進行管理以提高效能，僅在服務關機時將最終狀態持久化到 `state.db`。

### 2. 前端純粹化 (`run/colab_runner.py`)
*   **職責變更**：`colab_runner.py` 不再直接讀取資料庫，其職責被簡化為一個純粹的前端啟動器和監控器。
*   **通訊方式**：其內嵌的 JavaScript 現在透過標準的 `fetch` 函式，定期輪詢後端的 `/api/v1/status` 端點來更新儀表板。
*   **優雅關機**：當使用者在 Colab 中斷儲存格時，腳本會捕獲 `KeyboardInterrupt` 並向後端的 `/api/v1/shutdown` 端點發送一個 POST 請求。

### 3. 報告系統解耦 (`run/report.py`)
*   **離線化**：報告生成系統被完全確立為一個離線工具，它在主服務完全關閉後運行，其唯一依賴是 `state.db` 檔案。
*   **數據源統一**：`scripts/report_generator.py` 被重構為僅從 `state.db` 讀取數據，移除了原先解析日誌檔案的脆弱邏輯。

### 4. 測試體系升級 (`tests/`)
*   **API 整合測試**: 建立了 `tests/integration/test_api_driven_architecture.py`，使用 `pytest-aiohttp` 來驗證 API 的合約（請求與回應）是否正確。
*   **參數化測試**: 建立了 `tests/integration/test_parameterization.py`，驗證從前端 Colab 表單到後端服務的設定（如日誌等級）能夠被正確傳遞和應用。
*   **端對端生命週期測試**: 建立了 `tests/e2e/test_full_lifecycle.py`，這是一個獨立的腳本，模擬了從啟動、運行、中斷關機到生成報告的完整使用者流程，為整個系統的可靠性提供了最高級別的保證。

## 2025-08-01: V33 - 最終架構恢復與文件同步

**目標**：將專案的實際狀態與歷史文件中經過驗證的、最穩定的「資料庫驅動架構」完全對齊，並確保所有技術文件都精準反映此最終狀態。

### 1. 核心架構恢復 (Core Architecture Restoration)
*   **`scripts/launch.py` 恢復**: 恢復了此腳本作為後端核心的職責，負責管理 `state.db` 資料庫、執行主要任務並在結束後呼叫報告生成器。
*   **`run/colab_runner.py` 恢復**: 恢復了此腳本作為純前端顯示器的職責，它透過輪詢 `state.db` 來更新儀表板，實現了與後端的完全解耦。
*   **`run/report.py` 恢復**: 恢復了此腳本作為一個獨立的、任務結束後執行的報告觸發器的簡單職責。

### 2. 技術文件體系正式化 (Documentation Formalization)
*   **`ARCHITECTURE.md` 正式化**: 將 `ARCHITECTURE.md.bak` 更名為 `ARCHITECTURE.md`，確立其作為專案唯一、權威的架構藍圖。
*   **文件內容同步**:
    *   **掃描驅動更新**: 使用 `ls -R` 命令掃描專案的真實檔案結構。
    *   **`ARCHITECTURE.md` 更新**: 基於掃描結果，完全重寫了文件中的檔案結構圖和核心目錄詳解，使其 100% 反映專案現狀。
    *   **`README.md` 更新**: 全面重寫了 `README.md`，移除了所有過時的描述和檔案結構圖，使其與新的 `ARCHITECTURE.md` 完全對齊，並提供了基於當前架構的、準確的「如何開始」指南。
*   **整合測試更新**: 刪除了舊的、有問題的整合測試，並建立了全新的 `tests/integration/test_db_driven_architecture.py`，專門用於驗證當前這個穩定、解耦的架構。

## 2025-07-31: V33 - 穩定性強化與專案清理

**目標**：修復報告生成流程中的潛在錯誤，並對專案進行全面清理，移除過時檔案，使結構更清晰。

### 1. 核心流程強化 (Core Flow Hardening)
*   **錯誤傳遞修復**：修正了 `scripts/launch.py`，確保其在呼叫 `scripts/generate_report.py` 失敗時，能以非零錯誤碼退出。這解決了先前錯誤被「靜默」處理，導致上層測試（如 `smart_e2e_test.py`）無法偵測到失敗的問題。
*   **依賴自動化**：`scripts/launch.py` 現在會在使用 `pip` 執行報告生成前，自動安裝 `pandas`, `sparklines` 等必要依賴，確保了報告功能的開箱即用性。

### 2. 專案清理 (Project Cleanup)
*   **移除過時腳本**：刪除了 `scripts/phoenix_starter.py`，因其功能已完全被 `scripts/launch.py` 和 `scripts/smart_e2e_test.py` 的組合所取代。
*   **清理執行產物**：從版本控制中移除了多個在執行時才會產生的目錄和檔案，例如 `logs/`, `temp/`, `WEB1/`, `*.db` 檔案以及各種 `__pycache__` 目錄。
*   **強化 `.gitignore`**：更新了 `.gitignore` 檔案，確保所有被移除的執行產物在未來不會被意外地再次提交。

### 3. 文件現代化 (Documentation Modernization)
*   **`README.md` 更新**：完全重寫了「如何開始」部分，移除了對已刪除腳本的引用，並提供了基於 `run/colab_runner.py`（Colab 環境）和 `scripts/smart_e2e_test.py`（本機開發）的最新、最準確的操作指南。
*   **`docs/ARCHITECTURE.md` 更新**：修正了 Mermaid 圖表中的語法錯誤，並移除了描述過時 V4 架構的章節，使其內容與專案的 V33+ 架構保持一致。

## 2025-07-31: V33 - 專案結構重構與文件現代化

**目標**：提升專案的長期可維護性，使目錄結構更符合直覺，並讓技術文件與實際狀態保持同步。

### 1. 腳本重構 (Script Refactoring)

*   **變更前**：多個核心執行腳本 (`launch.py`, `smart_e2e_test.py`, `generate_report.py` 等) 散落在專案的根目錄，造成了結構上的混亂。
*   **變更後**：
    *   建立了一個新的 `scripts/` 目錄。
    *   所有上述腳本均被移動到 `scripts/` 目錄中，使其成為所有主要工具的統一入口。
    *   修正了所有因路徑變更而產生的 `import` 語句和 `subprocess` 呼叫，並透過完整測試驗證了功能的完整性。
*   **理由**：將可執行的工具與設定檔、原始碼目錄分離，是更標準、更清晰的專案組織方式，有助於新成員快速理解專案佈局。

### 2. 文件更新 (Documentation Update)

*   **`docs/ARCHITECTURE.md` 更新**:
    *   檔案結構圖已完全更新，以精確反映 `scripts/` 目錄的引入。
    *   Mermaid 架構流程圖中的節點也同步更新，顯示了 `scripts/launch.py` 等新路徑。
    *   擴充了「核心目錄與檔案詳解」章節，為每個主要目錄提供了更詳盡的功能說明。

*   **`README.md` 現代化**:
    *   **移除了舊的儀表板文字草圖**：原先在 `README.md` 中用於展示 `phoenix_starter.py` 啟動器畫面的詳細文字圖已被移除。作為歷史參考，被移除的草圖如下：
      ```text
      ┌─ 🚀 鳳凰之心視覺化啟動器 v9.2 ───────────────────────────────────────────────┐
      │                                                                              │
      ├─ 🌐 系統狀態 (System Status) ────────────────────────────────────────────────┤
      │ 🟢 運行中   核心: 25.6%   RAM: 0.3/8.3 GB (6.8%)   DISK: 1.0/10.5 GB (10.2%)  │
      │                                                                              │
      ├─ 📦 應用程式狀態 (Application Status) ───────────────────────────────────────┤
      │ 📈 Quant App         [🟢 測試通過]         🎤 Transcriber App   [🟢 測試通過]         │
      │                                                                              │
      ├─ 📜 即時日誌 (Live Logs) ────────────────────────────────────────────────────┤
      │ [04:59:53] [INFO] ============================== 4 passed in 2.62s =============================== │
      │ [04:59:53] [INFO] --- 開始為 App 'transcriber' 進行安全安裝 ---             │
      │ [04:59:53] [INFO] --- [4/4] 準備安裝: pydantic ---                          │
      │ [04:59:53] [INFO] 資源充足。開始安裝 'pydantic'...                         │
      │ [04:59:55] [INFO] ========================= 4 passed, 1 skipped in 0.63s ========================= │
      │                                                                              │
      ├─ ✨ 當前任務 (Current Task) ─────────────────────────────────────────────────┤
      │ [空閒]                                                                       │
      │                                                                              │
      └──────────────────────────────────────────────────────────────────────────────┘
      ```
    *   **簡化檔案結構圖**：用一個更簡潔、高層次的檔案結構圖替換了原有的詳細結構圖。
    *   **理由**：讓 `README.md` 更聚焦於其核心使命——提供專案的快速上手指南。詳細的技術細節和架構圖則統一由 `docs/ARCHITECTURE.md` 提供，實現了資訊的合理分層。

*   **`docs/CHANGELOG.md` 的建立**:
    *   建立了此檔案，作為未來所有重大變更的官方紀錄。
