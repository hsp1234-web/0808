# 關於檔案列表刷新後遺失問題的偵錯與分析總結

本文檔記錄了針對「網頁刷新後，已上傳的檔案紀錄消失」問題的完整偵錯過程、嘗試的解決方案、遇到的挑戰以及最終的結論。

## 1. 初始問題定義

使用者回報，當透過 Web UI 上傳檔案後，雖然檔案已成功儲存至 `uploads/` 目錄，但只要一重新整理頁面，UI 上的檔案列表就會被清空，造成資料遺失的錯覺。

## 2. 初步分析與解決方案構想

經過初步分析，我們確認了系統的設計是「以任務為中心」而非「以檔案為中心」。UI 列表的內容來自於資料庫中的「任務」記錄，而非直接讀取 `uploads/` 資料夾。如果一個檔案僅被上傳而未被處理（即未建立任務），它的記錄就不會存入資料庫，導致刷新後無法還原。

基於此，我們提出了第一個解決方案：**建立一個獨立的「檔案總管」功能**。

### 「檔案總管」方案計畫

-   **後端**：新增一個 `/api/list_files` API 端點，其功能為直接掃描 `uploads/` 目錄並回傳其中的檔案列表。
-   **前端**：在 `mp3.html` 中新增一個「檔案總管」UI 區塊，該區塊在頁面載入時呼叫 `/api/list_files`，並將返回的檔案動態渲染到畫面上。同時，為每個檔案項目提供「下載」、「刪除」、「送去轉錄」等操作按鈕。
-   **測試**：編寫一個 Playwright 端對端測試，用以驗證檔案的建立、列出、和刪除功能是否正常。

## 3. 實作與遭遇的頑固測試錯誤

我們按照計畫逐步實作了「檔案總管」功能。後端 API 和前端 UI 的基本程式碼都已完成。然而，在編寫 Playwright 自動化測試以驗證功能時，我們遇到了一個非常頑固且難以解釋的錯誤。

**核心症狀**：測試腳本可以在 `uploads/` 目錄中成功建立一個測試檔案，但後續的測試步驟中，Playwright 始終無法在前端 UI 上找到這個檔案對應的列表項目，導致測試因超時而失敗。

### 漫長的除錯之旅

為了解決這個問題，我們進行了一系列系統性的除錯：

1.  **確認依賴安裝**：最初測試因找不到 `@playwright/test` 模組而失敗。我們透過執行 `npm install` 和 `bun install` 解決了依賴問題。
2.  **確認伺服器運作**：我們發現 E2E 測試需要背景伺服器。我們找到了 `scripts/run_for_playwright.py` 腳本並在背景執行它。
3.  **除錯伺服器腳本**：發現伺服器腳本卡在安裝依賴階段。透過閱讀腳本，我們確認了它使用 `bun` 而非 `npm`，並在手動終止舊程序和安裝依賴後，成功啟動了伺服器。
4.  **修正測試腳本語法**：解決了因專案採用 ES Module 而導致的 `require is not defined` 和 `__dirname is not defined` 的語法問題。
5.  **隔離後端問題（突破點）**：為了判斷問題出在前端還是後端，我們在測試腳本中直接使用 `curl` 命令列工具去請求 `/api/list_files`。**結果證實，後端 API 運作完全正常**，它回傳了包含測試檔案的正確 JSON 資料。
6.  **隔離前端渲染問題**：既然後端正常且前端收到了資料，問題便直指前端的 DOM 渲染邏輯。我們將 `innerHTML` 的實作重構為更穩健的 `document.createElement`，但問題依舊。
7.  **最終除錯手段**：我們修改測試，讓它不再斷言元素可見，而是直接獲取整個列表的 `innerHTML` 並印出。結果顯示，列表的 `innerHTML` 始終是空的，證明了 DOM 沒有被成功渲染。

## 4. 使用者的洞見與方向轉變

在我們對這個渲染 Bug 束手無策時，使用者提出了關鍵性的回饋：**「我們是否不應該使用這麼複雜的檔案總管？」**

使用者建議，我們應該回歸問題的本質，即「讓已處理的任務記錄在刷新後能夠被還原」，而不是去新增一個全新的功能。

這個建議讓我們恍然大悟：**我們遇到的那個頑固的渲染 Bug，很可能就是導致原始問題（已完成任務列表刷新後消失）的真正元兇！** 現有的 `loadTaskHistory` 函式在試圖還原列表時，可能也因為同樣的渲染問題而失敗了。

## 5. 結論與最終狀態

根據使用者的指示，我們中止了所有的程式碼修改，並將這次寶貴的偵錯經驗記錄下來。

-   **最終結論**：問題的根源很可能是一個潛藏在前端 JavaScript 中的渲染錯誤，它阻礙了任何透過 `fetch` 非同步取得資料後對列表進行的 DOM 操作。
-   **已完成的工作**：
    -   新增了 `/api/list_files` 和 `/api/delete_file` 後端端點。
    -   在前端 `mp3.html` 中新增了「檔案總管」的 UI 和大部分邏輯。
    -   編寫了一個（雖然無法通過但極具診斷價值的）Playwright 測試案例。
-   **下一步（已中止）**：原定的下一步是集中火力解決這個核心的 DOM 渲染問題。

這次的偵錯過程雖然曲折，但最終成功地將問題範圍從一個模糊的「列表消失」現象，縮小並定位到一個具體的前端渲染 Bug，並驗證了後端 API 的正確性。
