# 前端重構計畫 (Frontend Refactor Plan)

本文檔記錄了將專案前端從單一 HTML 檔案 (`mp3.html`) 重構為現代化、模組化架構的策略與執行步驟。

## 1. 背景與動機

目前的前端由一個巨大的 `mp3.html` 檔案構成，其中包含了所有的 HTML、CSS 和 JavaScript。這種單體式架構導致了以下問題：

- **高度耦合**：多個非同步功能直接操作 DOM，引發了難以追蹤的渲染錯誤。
- **難以維護**：任何小修改都可能影響到其他不相關的功能。
- **測試困難**：無法對單一功能進行隔離測試，導致測試案例脆弱且不可靠。

為了解決這些根本性問題，並為專案未來的擴展打下良好基礎，我們決定進行一次徹底的前端架構重構。

## 2. 核心目標

- **模組化 (Modularity)**：將功能拆分成獨立、高內聚、低耦合的組件。
- **可測試性 (Testability)**：每個組件都應能夠被獨立測試。
- **清晰邊界 (Clear Boundaries)**：每個組件都有明確的職責和介面。
- **增量遷移 (Incremental Migration)**：以不破壞現有功能的方式，逐步建立新架構並遷移功能。

## 3. 技術選型

為了在不引入重量級框架的前提下達成目標，我們選擇以下技術組合：

- **原生 JavaScript 模組 (ES Modules)**：利用瀏覽器內建的模組系統來組織程式碼。
- **Bun Bundler**：使用 `bun` 的內建建置工具來打包、最佳化我們的程式碼，並處理模組相依性。
- **Playwright**：用於對獨立組件和整合後的前端進行端對端測試。

## 4. 執行策略：兩步走

我們採用「先內後外」、「先穩定，再優化」的策略。

### 第一階段：建立新架構骨架 (已完成)

此階段的目標是建立一個全新的、模組化的工作流程，並將第一個功能（檔案總管）作為範例遷移進來。所有步驟均已完成。

- **步驟 1：建立計畫文件** (已完成)
- **步驟 2：建立前端目錄結構** (已完成)
  - `src/frontend/`
  - `src/frontend/components/`
  - `src/frontend/assets/`
- **步驟 3：建立前端骨架檔案** (已完成)
  - `src/frontend/index.html` (新的 HTML 進入點)
  - `src/frontend/main.js` (新的 JS 進入點)
  - `src/frontend/components/FileBrowser.js` (第一個模組化組件)
- **步驟 4：設定建置指令** (已完成)
  - 在 `package.json` 中新增 `build` 指令。
- **步驟 5：更新 `.gitignore`** (已完成)
  - 將建置產物目錄 `dist/` 加入忽略清單。
- **步驟 6：執行初次建置並提交** (已完成)
  - 確保建置流程正常，並儲存進度。

### 第二階段：逐步遷移與功能完善

在骨架建立完成後，我們將按照「小步快走」的原則，逐一將 `mp3.html` 中的功能遷移到新的組件中。

- **遷移任務列表**：將「進行中任務」和「已完成任務」列表重構為獨立組件。
- **遷移 YouTube 功能**：將 YouTube 相關功能拆分為數個協同工作的組件。
- **遷移 WebSocket 邏輯**：建立一個專門的 `ApiService.js` 或 `SocketService.js` 模組來集中管理後端通訊。
- **引入狀態管理**：在必要時，引入一個輕量的全域狀態管理器，以解決跨組件通訊問題。
- **編寫單元/組件測試**：為每個遷移完成的組件編寫獨立的 Playwright 測試。
  - **TaskList 組件** (已完成): 已使用混合測試模式建立隔離的元件測試。

## 5. 風險管理

- **避免一次性大規模修改**：嚴格遵守「小步快走」原則，每次提交都應只包含一個小的、完整的功能或重構。
- **進度遺失**：在每個小步驟完成後立即提交，以避免因意外（如測試環境崩潰）而遺失工作進度。

---

## 附錄 A：元件測試策略

在重構過程中，我們為原生 JavaScript (Vanilla JS) 組件引入了 Playwright 元件測試。由於 Playwright 的元件測試工具主要針對 React/Vue/Svelte 等前端框架設計，我們採用了一種不依賴特定框架的「混合測試模式」。

此策略的核心思想是：**使用 Playwright 的標準頁面測試功能來為單一元件建立一個微型、隔離的測試環境。**

### 執行方法

1.  **測試載具 (Test Harness)**：在每個測試案例中，我們不直接 `mount` 組件，而是使用 `page.setContent()` 動態建立一個極簡的 HTML 頁面。這個頁面僅包含掛載目標組件所需的最小 DOM 結構（例如一個 `div` 容器）和必要的 CSS 樣式。

2.  **模擬 API (API Mocking)**：在 `page.setContent()` 之前，使用 `page.route()` 來攔截組件所需的所有後端 API 請求（例如 `/api/tasks`）。這樣可以確保測試資料的穩定與可控，使測試不依賴於後端伺服器的真實狀態。

3.  **動態注入與初始化**：使用 `page.evaluate()` 在瀏覽器的頁面環境中執行 JavaScript 程式碼。我們在這個函式中：
    - `import` 目標組件的 JS 模組。
    - `new` 一個組件實例。
    - 將模擬的外部依賴（如 `showStatusMessage` 函式）傳入其建構函式。
    - 呼叫組件的 `init()` 方法來觸發其生命週期，包括 API 的呼叫與渲染。

4.  **斷言 (Assertion)**：組件初始化完成後，在 Node.js 的測試環境中，使用標準的 Playwright `locator` 和 `expect` 來驗證組件渲染的 DOM 結構是否符合預期。

這個方法讓我們能夠在真實的瀏覽器環境中，對單一原生 JS 組件進行隔離測試，達成了「可測試性」的核心目標，並為未來所有新組件建立了一套可複製的測試模式。
