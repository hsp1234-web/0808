# 510A 專案 - 穩定性測試與修復計畫最終報告

本報告旨在全面記錄對 510A 專案中，因後端無法處理複雜檔名而引發的一系列核心功能失敗問題，所進行的診斷、修復與強化過程。

## 1. 初始問題

系統的核心功能——檔案預覽與下載，在檔名包含中文、空格或特殊符號時完全失效。E2E 測試顯示，瀏覽器在請求這些檔案時會因 404 Not Found 錯誤而最終導致超時。

## 2. 根本原因分析 (Root Cause Analysis)

經過深入的、跨越前後端的診斷，我們定位出問題的根源並非單一因素，而是一個由多個問題組成的連鎖故障：

1.  **後端檔案服務 BUG**: `api_server.py` 使用了 FastAPI 的 `StaticFiles` 來掛載 `/media` 目錄。此機制無法正確處理 URL 編碼的路徑（例如，將 `%20` 解碼為空格），導致無法將請求對應到伺服器上的實體檔案。
2.  **測試環境啟動失敗**: `scripts/run_for_playwright.py` 腳本在啟動 `api_server.py` 子進程時，未正確設定 `PYTHONPATH` 環境變數。這導致 `api_server.py` 因 `ModuleNotFoundError: No module named 'db'` 而在啟動時就崩潰。
3.  **前端 UI 邏輯不一致與 BUG**:
    *   **預覽體驗不統一**: MP4 影片使用彈出視窗預覽，而 MP3 音訊則開啟一個新分頁，體驗不一致。
    *   **下載按鈕失效**: 彈出式預覽視窗中的「下載」按鈕 `href` 屬性未被正確設定，導致功能無效。
    *   **頁面重載錯誤**: 從後端載入任務歷史時，前端對已經是 JSON 物件的資料進行了二次 `JSON.parse()`，導致在重新整理頁面時出現腳本錯誤。
4.  **E2E 測試脆弱性**:
    *   `e2e_mp3_preview.spec.js` 測試過於依賴「等待播放器超時」來判斷後端是否出錯，這種方式不僅速度緩慢，而且錯誤訊息模糊不清。
    *   測試在驗證 UI 元素時，存在競態條件 (Race Condition)，尤其是在被測元素會因錯誤處理而被快速移除時，導致測試結果不穩定。

## 3. 解決方案與實施步驟

針對上述問題，我們採取了一套涵蓋後端、前端、測試與環境的全方位解決方案：

1.  **後端修復 (`api_server.py`)**:
    *   徹底移除了有問題的 `StaticFiles` 掛載。
    *   實作了一個全新的 `/media/{file_path:path}` API 端點，該端點使用 `urllib.parse.unquote` 手動解碼路徑，從根本上解決了複雜檔名的問題。

2.  **測試環境修復 (`run_for_playwright.py`)**:
    *   修改了啟動腳本，在建立子進程時，明確地將 `src` 目錄加入到 `PYTHONPATH` 環境變數中，確保了 API 伺服器的穩定啟動。

3.  **前端重構與修復 (`mp3.html`)**:
    *   **統一預覽**: 重構了 `createActionButtons` 和 `openPreviewModal` 函數，讓 MP3 和 MP4 都使用統一的彈出式視窗進行預覽。
    *   **修復下載**: 確保了彈出視窗中的下載按鈕總是正確指向 `/api/download/{taskId}` 端點。
    *   **修復重載**: 移除了 `dispatchStatusUpdate` 函數中多餘的 `JSON.parse()` 呼叫。
    *   **調整預設值**: 將 Whisper 模型預設改為 `tiny`，光束大小改為 `1`，以優化首次使用的體驗。

4.  **E2E 測試強化 (`e2e_mp3_preview.spec.js`)**:
    *   **引入網路攔截**: 使用 `page.on('response', ...)` 來直接驗證後端 API 的回應狀態碼，取代了脆弱的逾時等待機制。
    *   **解決競態條件**: 為了解決 UI 元素因 `onerror` 而被快速移除的問題，我們為應用程式碼增加了 `data-last-preview-url` 測試專用屬性。測試現在透過驗證此屬性的值來確認預覽功能是否被正確呼叫，徹底解決了測試不穩定的問題。

## 4. 最終成果

本次更新成功地解決了所有已知問題。系統現在能夠穩定地處理包含任意特殊字元的檔名，前後端體驗更加統一、流暢，且擁有一套健壯、可靠、執行快速的自動化 E2E 測試來保障其核心功能的長期品質。
